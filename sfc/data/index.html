<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZA-LOG System - 13-File Architecture</title>
    
    <!-- ‚úÖ Favicon ƒë·ªÉ tr√°nh 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
    
    <!-- ‚úÖ Load CSS t·ª´ file ri√™ng -->
    <link rel="stylesheet" href="style.css">
    
    <!-- ‚úÖ Meta tags cho mobile -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <!-- ‚úÖ SYSTEM STATUS BAR -->
    <div id="systemStatus" class="system-status">
        <div class="status-item">
            <span class="status-label">üîß Config:</span>
            <span id="configStatus" class="status-value">Loading...</span>
        </div>
        <div class="status-item">
            <span class="status-label">üì° Proxy:</span>
            <span id="proxyStatus" class="status-value">Testing...</span>
        </div>
        <div class="status-item">
            <span class="status-label">üíæ Cache:</span>
            <span id="cacheStatus" class="status-value">Empty</span>
        </div>
        <div class="status-item">
            <span class="status-label">üìã Data:</span>
            <span id="dataStatus" class="status-value">0/5 APIs</span>
        </div>
    </div>

    <!-- ‚úÖ TAB NAVIGATION - Enhanced -->
    <div id="tabBar" class="tab-bar">
        <div class="tab-item active" data-tab="input" onclick="switchTab('input')">
            üìù Nh·∫≠p D·ªØ Li·ªáu
        </div>
        <div class="tab-item" data-tab="log" onclick="switchTab('log')">
            üìä Xem Log
        </div>
        <div class="tab-item" data-tab="analysis" onclick="switchTab('analysis')">
            üìà T√≠nh To√°n
        </div>
        <div class="tab-item" data-tab="config" onclick="switchTab('config')">
            ‚öôÔ∏è C·∫•u H√¨nh
        </div>
    </div>

    <!-- ‚úÖ TAB CONTENT CONTAINER -->
    <div id="tabContent" class="tab-content">

        <!-- üìù TAB 1: NH·∫¨P D·ªÆ LI·ªÜU -->
        <div id="inputContent" class="tab-panel active">
            
            <!-- ‚úÖ TOOLBAR ACTIONS -->
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-primary" id="addRowBtn" onclick="addNewRow()">
                        ‚ûï Th√™m D√≤ng
                    </button>
                    <button class="btn btn-secondary" id="saveLogBtn" onclick="saveLog()">
                        üíæ Ghi Log
                    </button>
                </div>
                <div class="toolbar-group">
                    <button class="btn btn-info" id="loadDataBtn" onclick="loadColumnData()">
                        üîÑ T·∫£i D·ªØ Li·ªáu
                    </button>
                    <button class="btn btn-warning" id="clearFormBtn" onclick="clearForm()">
                        üßπ X√≥a Form
                    </button>
                </div>
            </div>

            <!-- ‚úÖ EXCEL GRID - Enhanced v·ªõi data attributes -->
            <div class="excel-grid" id="gridElement" data-grid="main" data-columns="7">

                <!-- üü¶ HEADER ROW -->
                <div class="excel-cell header-cell" data-col="header-0">ID Chuy·∫øn</div>
                <div class="excel-cell header-cell" data-col="header-1">Ng√†y</div>
                <div class="excel-cell header-cell" data-col="header-2">Kh√°ch H√†ng</div>
                <div class="excel-cell header-cell" data-col="header-3">S·ªë L∆∞·ª£ng</div>
                <div class="excel-cell header-cell" data-col="header-4">Ca</div>
                <div class="excel-cell header-cell" data-col="header-5">T√†i X·∫ø</div>
                <div class="excel-cell header-cell" data-col="header-actions">H√†nh ƒê·ªông</div>

                <!-- üü® DATA ROW 1 - Enhanced v·ªõi validation attributes -->
                <div class="excel-cell" data-cell="0-0">
                    <input type="text" 
                           data-col="0" 
                           data-type="id" 
                           data-format="dd.mm.xxx"
                           data-auto-generate="true"
                           placeholder="01.01.001" />
                </div>
                
                <div class="excel-cell" data-cell="0-1">
                    <input type="text" 
                           data-col="1" 
                           data-type="date" 
                           data-format="dd/mm/yyyy"
                           placeholder="dd/mm/yyyy" />
                </div>
                
                <div class="excel-cell" data-cell="0-2">
                    <input type="text" 
                           data-col="2" 
                           data-type="customer" 
                           data-autocomplete="customer"
                           data-source="column-customer"
                           placeholder="T√™n kh√°ch h√†ng..." />
                </div>
                
                <div class="excel-cell" data-cell="0-3">
                    <input type="text" 
                           data-col="3" 
                           data-type="quantity" 
                           data-format="number+T"
                           placeholder="5 ho·∫∑c 5+3T" />
                </div>
                
                <div class="excel-cell" data-cell="0-4">
                    <input type="text" 
                           data-col="4" 
                           data-type="shift" 
                           data-options="ng√†y,ƒë√™m"
                           placeholder="ng√†y/ƒë√™m" />
                </div>
                
                <div class="excel-cell" data-cell="0-5">
                    <input type="text" 
                           data-col="5" 
                           data-type="employee" 
                           data-autocomplete="employee"
                           data-source="column-employee"
                           placeholder="T√™n t√†i x·∫ø..." />
                </div>
                
                <div class="excel-cell action-cell" data-cell="0-actions">
                    <button class="action-btn edit-btn" 
                            data-action="edit" 
                            title="S·ª≠a d√≤ng n√†y">‚úèÔ∏è</button>
                    <button class="action-btn delete-btn" 
                            data-action="delete" 
                            title="X√≥a d√≤ng n√†y">üóëÔ∏è</button>
                    <button class="action-btn split-btn" 
                            data-action="split" 
                            title="Chia chuy·∫øn theo quy t·∫Øc">‚öôÔ∏è</button>
                </div>

            </div> <!-- End Excel Grid -->

            <!-- ‚úÖ FORM SUMMARY -->
            <div class="form-summary">
                <div class="summary-item">
                    <span class="summary-label">T·ªïng d√≤ng:</span>
                    <span id="totalRows" class="summary-value">1</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">D√≤ng c√≥ d·ªØ li·ªáu:</span>
                    <span id="filledRows" class="summary-value">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tr·∫°ng th√°i:</span>
                    <span id="formStatus" class="summary-value">S·∫µn s√†ng</span>
                </div>
            </div>

        </div> <!-- End Input Content -->

        <!-- üìä TAB 2: XEM LOG -->
        <div id="logContent" class="tab-panel">
            
            <!-- ‚úÖ LOG CONTROLS -->
            <div class="log-controls">
                <div class="control-group">
                    <button class="btn btn-primary" id="refreshLogBtn" onclick="refreshLog()">
                        üîÑ Refresh Log
                    </button>
                    <button class="btn btn-info" id="filterLogBtn" onclick="filterLog()">
                        üîç Filter
                    </button>
                </div>
                <div class="control-group">
                    <input type="date" id="startDate" class="date-input">
                    <span>ƒë·∫øn</span>
                    <input type="date" id="endDate" class="date-input">
                    <button class="btn btn-secondary" onclick="filterByDate()">
                        üìÖ L·ªçc theo ng√†y
                    </button>
                </div>
            </div>

            <!-- ‚úÖ LOG STATUS -->
            <div id="logArea" class="log-area">
                <div id="logReady" class="log-status">
                    üìú S·∫µn s√†ng t·∫£i log...
                </div>
                <div id="logLoading" class="log-status" style="display: none;">
                    ‚è≥ ƒêang t·∫£i log t·ª´ server...
                </div>
                <div id="logFound" class="log-status" style="display: none;">
                    üìã T√¨m th·∫•y <span id="logCount">0</span> d√≤ng log
                </div>
                
                <!-- ‚úÖ LOG TABLE CONTAINER -->
                <div id="logTableContainer" class="log-table-container">
                    <!-- Log table s·∫Ω ƒë∆∞·ª£c render ƒë·ªông ·ªü ƒë√¢y -->
                </div>
            </div>

        </div> <!-- End Log Content -->

        <!-- üìà TAB 3: T√çNH TO√ÅN -->
        <div id="analysisContent" class="tab-panel">
            
            <!-- ‚úÖ DATA SOURCE SELECTION -->
            <div class="data-sources">
                <h3>üìä Ngu·ªìn D·ªØ Li·ªáu</h3>
                <div class="source-grid">
                    <div class="source-card" data-source="customer">
                        <div class="source-icon">üë•</div>
                        <div class="source-title">Kh√°ch H√†ng</div>
                        <div class="source-count" id="customerCount">0</div>
                        <button class="btn btn-sm" onclick="loadCustomerData()">T·∫£i</button>
                    </div>
                    <div class="source-card" data-source="employee">
                        <div class="source-icon">üë®‚Äçüíº</div>
                        <div class="source-title">Nh√¢n Vi√™n</div>
                        <div class="source-count" id="employeeCount">0</div>
                        <button class="btn btn-sm" onclick="loadEmployeeData()">T·∫£i</button>
                    </div>
                    <div class="source-card" data-source="vehicle">
                        <div class="source-icon">üöõ</div>
                        <div class="source-title">Ph∆∞∆°ng Ti·ªán</div>
                        <div class="source-count" id="vehicleCount">0</div>
                        <button class="btn btn-sm" onclick="loadVehicleData()">T·∫£i</button>
                    </div>
                    <div class="source-card" data-source="log">
                        <div class="source-icon">üìä</div>
                        <div class="source-title">Log Data</div>
                        <div class="source-count" id="logDataCount">0</div>
                        <button class="btn btn-sm" onclick="loadLogData()">T·∫£i</button>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ CALCULATION AREA -->
            <div class="calculation-area">
                <h3>üßÆ Khu V·ª±c T√≠nh To√°n</h3>
                <div class="calc-workspace">
                    <p>Khu v·ª±c n√†y s·∫Ω hi·ªÉn th·ªã:</p>
                    <ul>
                        <li>üìà B√°o c√°o th·ªëng k√™</li>
                        <li>üìä Bi·ªÉu ƒë·ªì ph√¢n t√≠ch</li>
                        <li>üî¢ T√≠nh to√°n t·ª± ƒë·ªông</li>
                        <li>üìã Xu·∫•t b√°o c√°o</li>
                    </ul>
                </div>
            </div>

        </div> <!-- End Analysis Content -->

        <!-- ‚öôÔ∏è TAB 4: C·∫§U H√åNH -->
        <div id="configContent" class="tab-panel">
            
            <!-- ‚úÖ API CONFIGURATION -->
            <div class="config-section">
                <h3>üîó C·∫•u H√¨nh API</h3>
                <div class="api-config">
                    <div class="config-item">
                        <label>FINAL API:</label>
                        <input type="text" id="finalApiUrl" readonly>
                        <button class="btn btn-sm" onclick="testAPI('final')">Test</button>
                    </div>
                    <div class="config-item">
                        <label>LOG API:</label>
                        <input type="text" id="logApiUrl" readonly>
                        <button class="btn btn-sm" onclick="testAPI('log')">Test</button>
                    </div>
                    <div class="config-item">
                        <label>BANGLUONG API:</label>
                        <input type="text" id="bangluongApiUrl" readonly>
                        <button class="btn btn-sm" onclick="testAPI('bangluong')">Test</button>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ SYSTEM INFO -->
            <div class="config-section">
                <h3>‚ÑπÔ∏è Th√¥ng Tin H·ªá Th·ªëng</h3>
                <div class="system-info">
                    <div class="info-item">
                        <span class="info-label">Architecture:</span>
                        <span class="info-value">13-File System</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Version:</span>
                        <span class="info-value">3.0.0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Browser:</span>
                        <span class="info-value" id="browserInfo">Detecting...</span>
                    </div>
                </div>
            </div>

        </div> <!-- End Config Content -->

    </div> <!-- End Tab Content -->

    <!-- ‚úÖ GLOBAL NOTIFICATIONS -->
    <div id="notifications" class="notifications-container">
        <!-- Notifications s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
    </div>

    <!-- ‚úÖ LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">ƒêang t·∫£i h·ªá th·ªëng...</div>
    </div>

    <!-- ‚úÖ AUTOCOMPLETE DROPDOWN -->
    <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;">
        <!-- Dropdown items s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
    </div>

    <!-- ‚úÖ SCRIPTS - Load theo th·ª© t·ª± dependency -->
    <script>
        // ===============================================================================
        // GLOBAL CONFIGURATION & STATE MANAGEMENT
        // ===============================================================================
        
        window.ZaLogSystem = {
            // System state
            state: {
                currentTab: 'input',
                systemReady: false,
                apisLoaded: 0,
                totalApis: 5
            },
            
            // Configuration
            config: {
                maxRows: 100,
                autoSaveInterval: 30000,
                cacheTimeout: 300000
            },
            
            // Event handlers registry
            handlers: new Map(),
            
            // Data cache
            cache: new Map(),
            
            // Initialization flag
            initialized: false
        };

        // ===============================================================================
        // ENHANCED TAB MANAGEMENT
        // ===============================================================================
        
        window.switchTab = function(tabName) {
            console.log(`üîÑ Switching to tab: ${tabName}`);
            
            try {
                // Update tab buttons
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Update tab panels
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                
                const targetPanel = document.getElementById(`${tabName}Content`);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                }
                
                // Update system state
                window.ZaLogSystem.state.currentTab = tabName;
                
                // Tab-specific actions
                switch(tabName) {
                    case 'log':
                        if (typeof window.ShowLog === 'function') {
                            window.ShowLog();
                        }
                        break;
                    case 'analysis':
                        updateDataCounts();
                        break;
                    case 'config':
                        loadConfigInfo();
                        break;
                }
                
                console.log(`‚úÖ Switched to ${tabName} tab`);
                
            } catch (error) {
                console.error('‚ùå Error switching tab:', error);
                showNotification('‚ö†Ô∏è C√≥ l·ªói khi chuy·ªÉn tab', 'error');
            }
        };

        // ===============================================================================
        // ENHANCED UTILITY FUNCTIONS
        // ===============================================================================
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (container.contains(notification)) {
                    container.removeChild(notification);
                }
            }, 3000);
        }

        function updateSystemStatus() {
            const configStatus = document.getElementById('configStatus');
            const proxyStatus = document.getElementById('proxyStatus');
            const cacheStatus = document.getElementById('cacheStatus');
            const dataStatus = document.getElementById('dataStatus');
            
            if (configStatus) configStatus.textContent = window._configLoaded ? '‚úÖ Ready' : '‚ùå Loading';
            if (proxyStatus) proxyStatus.textContent = window._proxyReady ? '‚úÖ Connected' : '‚è≥ Testing';
            if (cacheStatus) cacheStatus.textContent = `${window.ZaLogSystem.cache.size} items`;
            if (dataStatus) dataStatus.textContent = `${window.ZaLogSystem.state.apisLoaded}/${window.ZaLogSystem.state.totalApis} APIs`;
        }

        function updateDataCounts() {
            // Update data source counts in analysis tab
            const elements = {
                customerCount: document.getElementById('customerCount'),
                employeeCount: document.getElementById('employeeCount'),
                vehicleCount: document.getElementById('vehicleCount'),
                logDataCount: document.getElementById('logDataCount')
            };
            
            Object.entries(elements).forEach(([key, element]) => {
                if (element) {
                    const count = window.ZaLogSystem.cache.get(key.replace('Count', ''))?.length || 0;
                    element.textContent = count;
                }
            });
        }

        function loadConfigInfo() {
            // Load API URLs into config tab
            if (window.API_CONFIG) {
                const finalApi = document.getElementById('finalApiUrl');
                const logApi = document.getElementById('logApiUrl');
                const bangluongApi = document.getElementById('bangluongApiUrl');
                
                if (finalApi) finalApi.value = window.API_CONFIG.FINAL?.url || '';
                if (logApi) logApi.value = window.API_CONFIG.LOG?.url || '';
                if (bangluongApi) bangluongApi.value = window.API_CONFIG.BANGLUONG?.url || '';
            }
            
            // Update browser info
            const browserInfo = document.getElementById('browserInfo');
            if (browserInfo) {
                browserInfo.textContent = navigator.userAgent.split(' ').pop();
            }
        }

        // ===============================================================================
        // PLACEHOLDER FUNCTIONS - Will be replaced by modules
        // ===============================================================================
        
        // Input handling placeholders
        window.addNewRow = window.addNewRow || function() { showNotification('üîÑ Loading input handler...'); };
        window.saveLog = window.saveLog || function() { showNotification('üîÑ Loading save function...'); };
        window.deleteRow = window.deleteRow || function() { showNotification('üîÑ Loading delete function...'); };
        window.splitRow = window.splitRow || function() { showNotification('üîÑ Loading split function...'); };
        
        // Data loading placeholders
        window.loadCustomerData = window.loadCustomerData || function() { showNotification('üîÑ Loading customer processor...'); };
        window.loadEmployeeData = window.loadEmployeeData || function() { showNotification('üîÑ Loading employee processor...'); };
        window.loadVehicleData = window.loadVehicleData || function() { showNotification('üîÑ Loading vehicle processor...'); };
        window.loadLogData = window.loadLogData || function() { showNotification('üîÑ Loading log processor...'); };
        
        // Log handling placeholders
        window.refreshLog = window.refreshLog || function() { showNotification('üîÑ Loading log system...'); };
        window.filterLog = window.filterLog || function() { showNotification('üîÑ Loading filter system...'); };
        
        // Config testing placeholders
        window.testAPI = window.testAPI || function(apiName) { showNotification(`üîÑ Testing ${apiName} API...`); };

        // ===============================================================================
        // INITIALIZATION
        // ===============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ZA-LOG System starting...');
            
            // Show loading overlay
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.style.display = 'flex';
            
            // Update system status periodically
            setInterval(updateSystemStatus, 2000);
            
            // Initial status update
            updateSystemStatus();
            
            console.log('‚úÖ HTML foundation ready, waiting for modules...');
        });

        // Module loading detection
        window.addEventListener('zalog:system-ready', function() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.style.display = 'none';
            
            window.ZaLogSystem.state.systemReady = true;
            showNotification('‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!', 'success');
            
            console.log('üéâ ZA-LOG System fully initialized!');
        });
    </script>

    <!-- ‚úÖ Load main module system -->
    <script type="module" src="./chinh.js"></script>

</body>
</html>