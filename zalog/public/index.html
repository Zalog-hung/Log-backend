<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ZA-LOG</title>
    <!-- Load CSS t·ª´ file ri√™ng -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- üü¶ Thanh tab - Chuy·ªÉn ƒë·ªïi gi·ªØa form nh·∫≠p li·ªáu v√† xem log -->
    <div id="tabBar">
        <!-- Tab form nh·∫≠p d·ªØ li·ªáu -->
        <div class="tab-item active" onclick="switchTab('form')">Nh·∫≠p D·ªØ Li·ªáu</div>
        <!-- Tab xem log ƒë√£ l∆∞u -->
        <div class="tab-item" onclick="switchTab('log')">Xem Log</div>
    </div>

    <!-- V√πng ch·ª©a n·ªôi dung c·ªßa c√°c tab -->
    <div id="tabContent">

        <!-- Tab n·ªôi dung form nh·∫≠p li·ªáu -->
        <div id="formContent">
            <!-- B·∫£ng Excel-style ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu chuy·∫øn h√†ng -->
            <div class="excel-grid" id="gridElement">

                <!-- üü¶ D√≤ng ti√™u ƒë·ªÅ c·ªôt (7 c·ªôt: ID chuy·∫øn, Ng√†y, KH, S·ªë l∆∞·ª£ng, Ca, T√†i x·∫ø, H√†nh ƒë·ªông) -->
                <div class="excel-cell header-cell">ID chuy·∫øn</div>
                <div class="excel-cell header-cell">Ng√†y</div>
                <div class="excel-cell header-cell">Kh√°ch h√†ng</div>
                <div class="excel-cell header-cell">S·ªë l∆∞·ª£ng</div>
                <div class="excel-cell header-cell">Ca</div>
                <div class="excel-cell header-cell">T√†i x·∫ø</div>
                <div class="excel-cell header-cell">#</div>

                <!-- üü® D√≤ng ƒë·∫ßu ti√™n ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu -->
                <!-- C·ªôt 0: ID chuy·∫øn (t·ª± ƒë·ªông generate theo format dd.mm.xxx) -->
                <div class="excel-cell"><input type="text" data-col="0" /></div>
                <!-- C·ªôt 1: Ng√†y giao h√†ng (format dd/mm/yyyy) -->
                <div class="excel-cell"><input type="text" data-col="1" placeholder="dd/mm/yyyy" /></div>
                <!-- C·ªôt 2: T√™n kh√°ch h√†ng (c√≥ autocomplete) -->
                <div class="excel-cell"><input type="text" data-col="2" /></div>
                <!-- C·ªôt 3: S·ªë l∆∞·ª£ng h√†ng (cho ph√©p format nh∆∞ 5, 10T, 5+3T) -->
                <div class="excel-cell"><input type="text" data-col="3" /></div>
                <!-- C·ªôt 4: Ca l√†m vi·ªác (ng√†y/ƒë√™m) -->
                <div class="excel-cell"><input type="text" data-col="4" /></div>
                <!-- C·ªôt 5: T√™n t√†i x·∫ø -->
                <div class="excel-cell"><input type="text" data-col="5" /></div>
                <!-- C·ªôt h√†nh ƒë·ªông v·ªõi 3 n√∫t: S·ª≠a, X√≥a, Chia chuy·∫øn -->
                <div class="excel-cell action-cell">
                    <button onclick="editRow(this)" title="S·ª≠a d√≤ng n√†y">‚úèÔ∏è</button>
                    <button onclick="deleteRow(this)" title="X√≥a d√≤ng n√†y">üóëÔ∏è</button>
                    <button onclick="splitRow(this)" title="Chia chuy·∫øn theo quy t·∫Øc">‚öôÔ∏è</button>
                </div>

            </div> <!-- K·∫øt th√∫c b·∫£ng Excel -->

            <!-- Thanh ch·ª©c nƒÉng v·ªõi 2 n√∫t ch√≠nh --> 
            <div class="action-bar3">
                <!-- N√∫t th√™m d√≤ng m·ªõi v√†o b·∫£ng -->
                <div class="action-button3" onclick="addNewRow()">Th√™m d√≤ng</div>
                <!-- N√∫t l∆∞u t·∫•t c·∫£ d·ªØ li·ªáu v√†o log -->
                <div class="action-button3" onclick="saveLog()">Ghi Log</div>
            </div>
        </div>

        <!-- Tab n·ªôi dung xem log -->
        <div id="logContent" style="display: none;">
            <div style="padding: 20px; text-align: center; font-style: italic; color: #666;">
                üìú Khu v·ª±c hi·ªÉn th·ªã log s·∫Ω ƒë∆∞·ª£c load khi click tab "Xem Log"
            </div>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã log v√† tr·∫°ng th√°i h·ªá th·ªëng -->
        <div id="logArea">

            <!-- Th√¥ng b√°o h·ªá th·ªëng s·∫µn s√†ng -->
            <div id="logReady">[LOG] H·ªá th·ªëng s·∫µn s√†ng.</div>
            <!-- Th√¥ng b√°o ƒëang load log t·ª´ server -->
            <div id="logLoading" style="display: none;">‚è≥ ƒêang t·∫£i log...</div>
            <!-- Th√¥ng b√°o s·ªë l∆∞·ª£ng log t√¨m th·∫•y -->
            <div id="logFound" style="display: none;">
                üìã T√¨m th·∫•y <span id="logCount">0</span> d√≤ng log c√≥ d·ªØ li·ªáu:
            </div>

            <!-- N√∫t c·∫≠p nh·∫≠t log, ƒë·∫∑t ·ªü g√≥c ph·∫£i -->
            <div class="log-button-container">
                <button class="log-update-button" onclick="capNhatLog()" title="L√†m m·ªõi d·ªØ li·ªáu log t·ª´ server">[LOG] C·∫≠p Nh·∫≠t</button>
            </div>

            <!-- Container ch·ª©a b·∫£ng log s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
            <div id="logTableContainer"></div>
        </div>
    </div>

    <!-- Script d·ª± ph√≤ng - Ch·∫°y tr∆∞·ªõc khi load module ch√≠nh -->
    <script>
    // =============================================================================
    // C√ÅC FUNCTION D·ª∞ PH√íNG - ƒê·∫£m b·∫£o HTML kh√¥ng b·ªã l·ªói khi JS ch∆∞a load xong
    // =============================================================================

    /**
     * Chuy·ªÉn ƒë·ªïi gi·ªØa tab Form v√† Log
     * @param {string} tabName - T√™n tab: 'form' ho·∫∑c 'log'
     */
    window.switchTab = window.switchTab || function(tabName) {
        console.log('üîÑ Chuy·ªÉn sang tab:', tabName);
        
        try {
            // X√≥a class active kh·ªèi t·∫•t c·∫£ tab
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Th√™m class active cho tab ƒë∆∞·ª£c click
            event.target.classList.add('active');
            
            // L·∫•y c√°c v√πng n·ªôi dung
            const formContent = document.getElementById('formContent');
            const logContent = document.getElementById('logContent');
            
            if (tabName === 'form') {
                // Hi·ªán form, ·∫©n log
                formContent.style.display = 'block';
                logContent.style.display = 'none';
                console.log('‚úÖ ƒê√£ chuy·ªÉn sang tab Nh·∫≠p D·ªØ Li·ªáu');
            } else if (tabName === 'log') {
                // ·∫®n form, hi·ªán log
                formContent.style.display = 'none';
                logContent.style.display = 'block';
                console.log('‚úÖ ƒê√£ chuy·ªÉn sang tab Xem Log');
                
                // T·ª± ƒë·ªông load log n·∫øu c√≥ function ShowLog
                if (typeof window.ShowLog === 'function') {
                    window.ShowLog();
                }
            }
        } catch (error) {
            console.error('‚ùå L·ªói khi chuy·ªÉn tab:', error);
            alert('‚ö†Ô∏è C√≥ l·ªói khi chuy·ªÉn tab. Vui l√≤ng th·ª≠ l·∫°i!');
        }
    };

    /**
     * L∆∞u d·ªØ li·ªáu t·ª´ form v√†o log
     */
    window.saveLog = window.saveLog || function() {
        console.log('üíæ B·∫Øt ƒë·∫ßu l∆∞u d·ªØ li·ªáu...');
        
        try {
            // Thu th·∫≠p t·∫•t c·∫£ input trong form
            const allInputs = document.querySelectorAll('input[data-col]');
            const rows = [];
            
            // Nh√≥m input th√†nh t·ª´ng d√≤ng (6 input m·ªói d√≤ng)
            for (let i = 0; i < allInputs.length; i += 6) {
                const rowInputs = Array.from(allInputs).slice(i, i + 6);
                const rowData = rowInputs.map(input => input.value.trim());
                
                // Ch·ªâ th√™m d√≤ng c√≥ d·ªØ li·ªáu (kh√¥ng r·ªóng ho√†n to√†n)
                if (rowData.some(value => value !== '')) {
                    rows.push({
                        idChuyen: rowData[0] || '',
                        ngay: rowData[1] || '',
                        khachHang: rowData[2] || '',
                        soLuong: rowData[3] || '',
                        ca: rowData[4] || '',
                        taiXe: rowData[5] || ''
                    });
                }
            }
            
            if (rows.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!\nVui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt d√≤ng c√≥ th√¥ng tin.');
                return;
            }
            
            console.log('üìã D·ªØ li·ªáu s·∫Ω l∆∞u:', rows);
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang l∆∞u
            const saveButton = document.querySelector('.action-button3:last-child');
            const originalText = saveButton.textContent;
            saveButton.textContent = '‚è≥ ƒêang l∆∞u...';
            saveButton.style.pointerEvents = 'none';
            
            // TODO: K·∫øt n·ªëi v·ªõi API th·ª±c t·∫ø ·ªü ƒë√¢y
            // Hi·ªán t·∫°i ch·ªâ m√¥ ph·ªèng v·ªõi setTimeout
            setTimeout(() => {
                saveButton.textContent = originalText;
                saveButton.style.pointerEvents = '';
                alert(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng ${rows.length} d√≤ng d·ªØ li·ªáu!`);
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu:', error);
            alert('‚ö†Ô∏è C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra v√† th·ª≠ l·∫°i!');
        }
    };

    /**
     * Ch·ªânh s·ª≠a d√≤ng ƒë∆∞·ª£c ch·ªçn
     * @param {HTMLElement} button - N√∫t edit ƒë∆∞·ª£c click
     */
    window.editRow = window.editRow || function(button) {
        console.log('‚úèÔ∏è B·∫Øt ƒë·∫ßu ch·ªânh s·ª≠a d√≤ng');
        
        try {
            // T√¨m d√≤ng ch·ª©a n√∫t edit
            const actionCell = button.closest('.excel-cell');
            const gridElement = document.querySelector('.excel-grid');
            const allCells = Array.from(gridElement.children);
            const actionIndex = allCells.indexOf(actionCell);
            
            // T√≠nh v·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa d√≤ng (m·ªói d√≤ng c√≥ 7 √¥)
            const rowStartIndex = Math.floor(actionIndex / 7) * 7;
            const rowCells = allCells.slice(rowStartIndex, rowStartIndex + 6);
            const inputs = rowCells.map(cell => cell.querySelector('input')).filter(Boolean);
            
            if (inputs.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y √¥ input ƒë·ªÉ ch·ªânh s·ª≠a!');
                return;
            }
            
            // Focus v√†o √¥ ƒë·∫ßu ti√™n v√† select to√†n b·ªô text
            inputs[0].focus();
            inputs[0].select();
            
            // L√†m n·ªïi b·∫≠t d√≤ng ƒëang s·ª≠a b·∫±ng m√†u n·ªÅn
            inputs.forEach(input => {
                input.style.backgroundColor = '#fff3cd';
                input.style.transition = 'background-color 0.3s';
            });
            
            // Tr·ªü v·ªÅ m√†u b√¨nh th∆∞·ªùng sau 2 gi√¢y
            setTimeout(() => {
                inputs.forEach(input => {
                    input.style.backgroundColor = '';
                });
            }, 2000);
            
            console.log('‚úÖ ƒê√£ focus v√†o d√≤ng ƒë·ªÉ ch·ªânh s·ª≠a');
            
        } catch (error) {
            console.error('‚ùå L·ªói khi edit d√≤ng:', error);
            alert('‚ö†Ô∏è C√≥ l·ªói khi ch·ªânh s·ª≠a d√≤ng. Vui l√≤ng th·ª≠ l·∫°i!');
        }
    };

    /**
     * C·∫≠p nh·∫≠t d·ªØ li·ªáu log t·ª´ server
     */
    window.capNhatLog = window.capNhatLog || function() {
        console.log('üîÑ C·∫≠p nh·∫≠t log...');
        
        try {
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang load
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ ƒêang c·∫≠p nh·∫≠t...';
            button.disabled = true;
            
            // G·ªçi function ShowLog n·∫øu c√≥
            if (typeof window.ShowLog === 'function') {
                window.ShowLog().then(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    console.log('‚úÖ C·∫≠p nh·∫≠t log th√†nh c√¥ng');
                }).catch((error) => {
                    button.textContent = originalText;
                    button.disabled = false;
                    console.error('‚ùå L·ªói c·∫≠p nh·∫≠t log:', error);
                });
            } else {
                // Fallback n·∫øu ch∆∞a c√≥ ShowLog
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('‚ö†Ô∏è Ch·ª©c nƒÉng c·∫≠p nh·∫≠t log ch∆∞a s·∫µn s√†ng!');
                }, 1000);
            }
            
        } catch (error) {
            console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t log:', error);
            alert('‚ö†Ô∏è C√≥ l·ªói khi c·∫≠p nh·∫≠t log. Vui l√≤ng th·ª≠ l·∫°i!');
        }
    };

    // Placeholder functions ƒë·ªÉ tr√°nh l·ªói
    window.addNewRow = window.addNewRow || function() {
        console.log('‚ö†Ô∏è Function addNewRow ch∆∞a ƒë∆∞·ª£c load');
        alert('Ch·ª©c nƒÉng n√†y ƒëang t·∫£i...');
    };

    window.deleteRow = window.deleteRow || function() {
        console.log('‚ö†Ô∏è Function deleteRow ch∆∞a ƒë∆∞·ª£c load');
        alert('Ch·ª©c nƒÉng n√†y ƒëang t·∫£i...');
    };

    window.splitRow = window.splitRow || function() {
        console.log('‚ö†Ô∏è Function splitRow ch∆∞a ƒë∆∞·ª£c load');
        alert('Ch·ª©c nƒÉng n√†y ƒëang t·∫£i...');
    };

    // =============================================================================
    // KH·ªûI T·∫†O KHI TRANG WEB LOAD XONG
    // =============================================================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üü¢ HTML ƒë√£ load xong, ƒëang ch·ªù JS modules...');
        
        // Ki·ªÉm tra xem c√°c JS module ƒë√£ load ch∆∞a
        const checkModules = setInterval(() => {
            if (typeof window.addNewRow === 'function' && 
                typeof window.deleteRow === 'function' && 
                typeof window.splitRow === 'function') {
                console.log('‚úÖ T·∫•t c·∫£ JS modules ƒë√£ load th√†nh c√¥ng!');
                clearInterval(checkModules);
            }
        }, 500);
        
        // Timeout sau 10 gi√¢y n·∫øu JS kh√¥ng load ƒë∆∞·ª£c
        setTimeout(() => {
            clearInterval(checkModules);
            if (typeof window.addNewRow !== 'function') {
                console.warn('‚ö†Ô∏è M·ªôt s·ªë ch·ª©c nƒÉng JS ch∆∞a s·∫µn s√†ng sau 10 gi√¢y');
                // V·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng v·ªõi functions d·ª± ph√≤ng
            }
        }, 10000);
    });
    </script>

    <!-- Load module ch√≠nh sau khi c√≥ functions d·ª± ph√≤ng -->
    <script type="module" src="./chinh.js"></script>

</body>
</html>